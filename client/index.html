<!DOCTYPE html>
<html>
<head>
    <script src="https://cdn.socket.io/socket.io-1.2.0.js"></script>
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.1/jquery.min.js"></script>
    <script src="/client/two.min.js"></script>
    <script src="/client/url.js"></script>
    <link rel="stylesheet" type="text/css" href="/client/main.css"/>
	<title>Client!</title>
</head>
<body>
<div id="name"></div>
<div id="view"></div>

<script type="text/javascript">
var type = /(canvas|webgl)/.test(url.type) ? url.type : 'svg';
var elem = document.getElementById('view');
var two = new Two({ width: elem.width, height: elem.height }).appendTo(elem);

var id = -1;
var state = {'x': 0, 'y':0};
var socket = io();
var circle = new Two.Ellipse(state.x, state.y, 50);
var group = new Two.Group();
var others = new Two.Group();
var otherGroups = {};
group.add(circle);
two.add(group);
two.add(others);

$("#view").click(onViewClick);

function onViewClick(event){
	state['x'] = event.clientX;
	state['y'] = event.clientY;
	updateSelf();
	sendState();
}

function updateSelf(){
	group.translation.set(state.x, state.y);
	two.update();
}

function sendState(){
	emit('update_state', id, state);
}

socket.on('on_connect', function(msg){
	if(id<0){
		id = msg;
		$('#name').append("<p>MY NAME IS: "+id+"</p>");
	}
	emit('connect_ack', id, state);
});

socket.on('server_update', function(msg){
	temp={};
	for(var i in otherGroups){
		if(i in msg){
			temp[i] = otherGroups[i];
		}else{
			two.remove(otherGroups[i]);
		}
	}
	otherGroups = temp;
	for(var i in msg){
		var clientState = msg[i];
		if(i!=id && clientState!=null){
			if(i in otherGroups){
				//update group translation with clientstate
				otherGroups[i]['newstate'] = clientState;
				otherGroups[i].translation.set(clientState.x, clientState.y);
				otherGroups[i]['oldstate'] = otherGroups[i]['newstate'];
			}else{
				//make new entry with id, new group, with circle at origin, then translate
				otherGroups[i] = new Two.Group();
				otherGroups[i].add(new Two.Ellipse(0,0,25));
				otherGroups[i]['oldstate'] = clientState;
				otherGroups[i]['newstate'] = clientState;
				otherGroups[i].translation.set(clientState.x, clientState.y);
				two.add(otherGroups[i]);
			}
		}else if(i==id){
			emit("update_ack", id, state);
		}
	}

	two.update();
});


function emit(channel, clientID, clientData){
	var messagePack = {'ID':clientID, "STATE":clientData};
	socket.emit(channel, messagePack);
}


function updateObject(obj, newObj){
	if(newObj!=null){
		for(var key in obj){
			if(key in newObj){
				obj[key] = newObj[key];
			}
		}
		for(var key in newObj){
			if(!(key in obj)){
				obj[key] = newObj[key];
			}
		}
	}
}

two.bind('update', function(framecount){

});
	


</script>

</body>
</html>